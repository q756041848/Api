var interObj={init:function(){var a=this;interBasicObj.init();interParamObj.init();interRespObj.init();$("#interPanel").keypress(function(b){if(b.ctrlKey&&(b.which==13||b.which==10)){$("#saveInterBtn").trigger("click")}});$("#saveInterBtn").click(function(){if(isFormValid("basicInfoFrom")){var b=$("#interOperTypeId").val();if(b=="add"||b=="copy"){a.addOper()}else{if(b=="update"){a.updateOper()}}}});$(".changed-tip").changedTip()},isChanged:function(b){var a=$("#interPanel").is(":visible")&&$(".changed-tip").changedTip("isChanged");if(a){bootbox.confirm("接口信息未保存,您确定离开吗?",function(){$(".changed-tip").changedTip("skip");b()})}else{b()}},initAddOper:function(a){resetValidForm("basicInfoFrom");$("#interId").val("");if(a!=undefined){$("#interModuleId").val(a)}$("#reqParamTable").nestable("clear");$("#reqRespTable").nestable("clear");$("#interOperTypeId").val("add");$("#interOperNameId").html("【新增】");$(".nodeInfo").hide();$("#interPanel").show();$(".changed-tip").changedTip("init")},buildInterParam:function(){var c=$("#basicInfoFrom").find("*").getFieldsValue();c.interId=$("#interId").val();c.docId=$("#docId").val();c.description=$("#interDesc").code();var b=$("#reqParamTable").nestable("getData");c.reqParam=JSON.stringify(b);var a=$("#reqRespTable").nestable("getData");c.reqResp=JSON.stringify(a);return c},addOper:function(){var a=this;doPost("auth/doc/inter/json/addDetail.htm",a.buildInterParam(),function(b){notice("新增成功",function(){$(".changed-tip").changedTip("init");interTreeObj.addNode(b);interObj.initAddOper()})})},updateOper:function(){var b=this;var a=b.buildInterParam();doPost("auth/doc/inter/json/updateDetail.htm",a,function(){$(".changed-tip").changedTip("init");notice("修改成功",function(){var c=$("#basicInfoFrom").data("treeNodeId");if(c){interTreeObj.updateNodeNameByNodeId(c,a.name)}})})},loadInfo:function(b,a,c){$(".nodeInfo").hide();$("#interPanel").show();$("#basicInfoFrom").data("treeNodeId",c);resetValidForm("basicInfoFrom");var d=new Object();d.interId=b;d.docId=$("#docId").val();doGet("auth/doc/inter/json/detailInfo.htm",d,function(e){interBasicObj.loadInfo(e.basicInfo);interParamObj.loadList(e.paramList);interRespObj.loadList(e.respList);if(a==true){$("#interId").val("");$("#interOperTypeId").val("copy");$("#interOperNameId").html("【复制】")}else{$("#interId").val(b);$("#interOperTypeId").val("update");$("#interOperNameId").html("【编辑】")}$(".changed-tip").changedTip("init")})}};var interBasicObj={init:function(){var a=this;a.loadModuleSelect();$("#interDesc").summernote({height:150});$("#basicInfoFrom").bootstrapValidator({fields:{name:{validators:{notEmpty:{message:"接口名称不能为空"}}},path:{validators:{notEmpty:{message:"请求url不能为空"}}}}})},loadModuleSelect:function(){$("#interModuleId").empty();initSelectRemote("auth/doc/module/json/list.htm","docId="+$("#docId").val(),"#interModuleId")},loadInfo:function(a){$("#basicInfoFrom").find("*").setFieldsValue(a);$("#interDesc").code(a.description)}};var interParamObj={init:function(){var a=this;a.initReqParamTable();$("#reqFormatSchemaBtn").click(function(){var d=$("#reqExtSchemaArea").val();try{var b=JSON.parse(d);$("#reqExtSchemaArea").val(formatJson(b))}catch(c){notice(c.message)}});$("#reqConfirmBtn").click(function(){if(!validJson($("#reqExtSchemaArea").val())){notice("自定义json格式错误!");return false}$("#reqExtSchemaModal").data("row").find("[name='extSchema']").val($("#reqExtSchemaArea").val());$("#reqExtSchemaModal").data("row",null);$("#reqExtSchemaModal").modal("hide")});$("#saveMoreBtn").click(function(){var c=$("#moreModal").data("row");var b=$("#moreForm").find("*").getFieldsValue();c.find("*").setFieldsValue(b);$("#moreModal").data("row",null);$("#moreModal").modal("hide")});a.initBatchAdd()},loadList:function(a){$("#reqParamTable").nestable("clear");$("#reqParamTable").nestable("loadData",a)},initReqTypeSelect:function(e){var c=$(e).find(".req-param-type");var d=c.find("option[value='cust_json']");var a=c.find("option[value='sys_ref']");var b=$(e).find(".req-param-position");b.change(function(){var f=c.val();if($(this).val()=="body"){d.removeAttr("disabled");a.removeAttr("disabled")}else{if(f=="cust_json"||f=="sys_ref"){c.val("sys_string");c.trigger("change")}d.attr("disabled","disabled");a.attr("disabled","disabled")}});b.trigger("change")},initExtSchema:function(d){var c=$(d).find(".ext-schema-btn");var b=$(d).find(".cust-ref-schema");c.bind("click",d,function(f){$("#reqExtSchemaModal").data("row",$(d));var g=$(d).find("[name='extSchema']").val();if(g.length==0){g='{\n\t"example": "type,description"\n}'}$("#reqExtSchemaArea").val(g);$("#reqExtSchemaModal").modal("show")});var a=$(d).find(".req-param-type");$(d).find(".req-param-type").change(function(){var e=$(this).val();if(e=="cust_json"){c.removeAttr("disabled")}else{c.attr("disabled","disabled")}if(e=="sys_ref"){b.removeAttr("disabled")}else{b.attr("disabled","disabled")}});a.trigger("change")},initMoreBtn:function(b){var a=$(b).find(".more-btn");a.bind("click",b,function(d){$("#moreForm").resetForm();$("#moreModal").data("row",$(b));var c=$(b).find("*").getFieldsValue();$("#moreForm").find("*").setFieldsValue(c);$("#moreModal").modal("show")})},initReqParamTable:function(){var a=this;$("#reqParamTable").nestable({group:1,enableAddChild:false,maxDepth:1,getItemContentTmpl:function(){return getTmpl("#reqParamContentTmpl")},afterAddChild:function(b){a.initExtSchema(b);a.initMoreBtn(b);a.initReqTypeSelect(b)}});$("#addReqParamBtn").on("click",function(){$("#reqParamTable").nestable("addChild")});$("#clearReqParamBtn").on("click",function(){$("#reqParamTable").nestable("clear")})},initBatchAdd:function(){var a=this;$("#batchAddReqParamBtn").click(function(){resetValidForm("batchAddReqParamForm")});$("#parseReqParamBtn").click(function(){var d=$("input[name='reqParamAddType']:checked").val();var e=$.trim($("#batchAddReqParamArea").val());var c=a.parseReqParamForBatchAdd(e);if(d=="append"){var b=$("#reqParamTable").nestable("getData");if(b.length>0){c=b.concat(c)}}$("#reqParamTable").nestable("loadData",c);$("#batchAddReqParamFormModal").modal("hide")})},parseReqParamForBatchAdd:function(d){var h=this;var c=new Array();var b=null;var a=0;if(isNull(d)){return c}var f=d.split("&");var g="";for(var e=0;e<f.length;e++){g=$.trim(f[e]);if(isNull(g)){continue}paramInfo=g.split("=");if(paramInfo.length>0){b=new Object();b.code=$.trim(paramInfo[0]);b.type="sys_string";if(paramInfo.length==2){b.defValue=paramInfo[1];b.type=interUtilObj.parseParamValType(paramInfo[1])}c[a++]=b}}return c}};var interRespObj={init:function(){var a=this;a.initReqRespTable();a.initSchemaTypeSelect();a.initCustSchemaTable();a.initAddOper();a.initSaveOper();a.initRespFormat();a.initMock();a.initImportJson()},initReqRespTable:function(){var a=this;$("#reqRespTable").nestable({group:2,enableAddChild:false,maxDepth:1,getItemContentTmpl:function(){return getTmpl("#reqRespContentTmpl")},afterAddChild:function(c){var b=$(c);b.find(".resp-oper-update").bind("click",b,function(d){a.loadInfo(d.data)});b.find(".resp-oper-update-mock").bind("click",b,function(d){a.loadMockInfo(d.data)})}});$("#clearReqRespBtn").on("click",function(){$("#reqRespTable").nestable("clear")})},initRespFormat:function(){var a=this;$("#respFormatSchemaBtn").click(function(){a.formatJsonArea($("#respExtSchemaArea"))})},initSchemaTypeSelect:function(){$("#schemaTypeSelect").change(function(){var a=$("#schemaTypeSelect").val();if(a=="sys_object"||a=="sys_array"){$("#custSchemaTable").show();$("#addCustSchemaRootNodeBtn").show()}else{$("#custSchemaTable").hide();$("#addCustSchemaRootNodeBtn").hide()}if(a=="sys_ref"){$("#refSchemaDiv").show()}else{$("#refSchemaDiv").hide()}if(a=="cust_json"){$("#respExtSchemaDiv").show();$("#respFormatSchemaBtn").show()}else{$("#respExtSchemaDiv").hide();$("#respFormatSchemaBtn").hide()}})},initCustSchemaTable:function(){$("#custSchemaTable").nestable({group:3,maxDepth:10,getItemContentTmpl:function(){return getTmpl("#custSchemaContentTmpl")},afterAddChild:function(a){var b=a.find(".cust-schema-type").first();b.change(function(){var d=a.find(".cust-ref-schema").first().parent();var c=$(this).val();if(c=="sys_ref"){d.show()}else{d.hide()}if(c=="sys_object"||c=="sys_array"){a.children("[data-action='addChild']").show()}else{a.children("[data-action='addChild']").hide()}});b.trigger("change")}});$("#addCustSchemaRootNodeBtn").click(function(){$("#custSchemaTable").nestable("addChild")})},initAddOper:function(){$("#addRespBtn").click(function(){resetValidForm("respCustSchemaForm");$("#custSchemaTable").nestable("clear");$("#schemaTypeSelect").trigger("change");$("#interRespOperTypeId").val("add");var a='{\n\t"example": "type,description"\n}';$("#respExtSchemaArea").val(a)})},initImportJson:function(){var a=this;$("#importRespBtn").click(function(){resetValidForm("importRespForm")});$("#parseRespBtn").click(function(){var b=$.trim($("#importRespArea").val());var f=a.convertJsonObj(b);var c=a.parseRespByJson(f);var e=new Object();e.code="new resp";e.valid=true;e.type=interUtilObj.parseParamValType(f);e.custSchema=JSON.stringify(c);var d=$("#reqRespTable").nestable("getOptions").getItemTmpl();d.find("*").setFieldsValue(e);$("#reqRespTable").nestable("addChild",null,d);$("#importRespFormModal").modal("hide")})},loadInfo:function(c){var b=c.find("*").getFieldsValue();$("#respCustSchemaForm").data("row",c);$("#interRespOperTypeId").val("update");$("#custSchemaTable").nestable("clear");$("#respCustSchemaForm").find("*").setFieldsValue(b);var a=b.type;if(a=="sys_object"||a=="sys_array"){var d=JSON.parse(b.custSchema);$("#custSchemaTable").nestable("loadData",d)}$("#schemaTypeSelect").trigger("change")},serializeCustSchemaForm:function(){var c=$("#respCustSchemaForm").find("*").getFieldsValue();c.valid=true;var a=$("#schemaTypeSelect").val();if(a=="sys_object"||a=="sys_array"){var b=$("#custSchemaTable").nestable("getData");c.custSchema=JSON.stringify(b)}return c},addOper:function(){var b=this.serializeCustSchemaForm();if(!b.valid){notice("编码不能为空");return}var a=$("#reqRespTable").nestable("getOptions").getItemTmpl();a.find("*").setFieldsValue(b);$("#reqRespTable").nestable("addChild",null,a)},updateOper:function(){var a=this.serializeCustSchemaForm();if(!a.valid){notice("编码不能为空");return}$("#respCustSchemaForm").data("row").find("*").setFieldsValue(a)},initSaveOper:function(){var a=this;$("#respCustSchemaForm").bootstrapValidator({fields:{code:{validators:{notEmpty:{message:"编码不能为空"}}}}});$("#saveRespBtn").click(function(){if(isFormValid("respCustSchemaForm")){if($("#schemaTypeSelect").val()=="cust_json"&&!validJson($("#respExtSchemaArea").val())){notice("自定义json格式错误!");return false}var b=$("#interRespOperTypeId").val();if(b=="add"){a.addOper()}else{if(b=="update"){a.updateOper()}}$("#respCustSchemaForm").data("row",null);$("#respSchemaFormModal").modal("hide")}})},loadList:function(a){$("#reqRespTable").nestable("clear");$("#reqRespTable").nestable("loadData",a)},loadMockInfo:function(a){var b=a.find("[name='mockData']").val();var c=a.find("[name='mockRule']").val();$("#mockForm").data("row",a);$("#mockPreviewArea").val("");$("#mockDataArea").val(b);$("#mockRuleArea").val(c)},initMock:function(){var a=this;$("#mockFormatBtn").click(function(){a.formatJsonArea($("#mockDataArea"));a.formatJsonArea($("#mockRuleArea"))});$("#mockPreviewBtn").click(function(){a.previewMockData()});$("#saveMockBtn").click(function(){var b=$("#mockForm").data("row");b.find("[name='mockData']").val($("#mockDataArea").val());b.find("[name='mockRule']").val($("#mockRuleArea").val());$("#mockForm").data("row",null);$("#mockFormModal").modal("hide")})},formatJsonArea:function(a){var b=a.val();if(isNull(b)){return}try{var d=JSON.parse(b);a.val(formatJson(d))}catch(c){notice(c.message)}},previewMockData:function(){var a=new Object();a.mockRule=$("#mockRuleArea").val();doPost("pass/mock/dynamic/json/preview.htm",a,function(b){$("#mockPreviewArea").val(b)})},convertJsonObj:function(b){var c=new Object;try{c=JSON.parse(b)}catch(a){notice(a.message)}return c},parseRespByJson:function(c){var b=this;var a=new Array();if(c==undefined||c==null){return a}b.parseJsonSchema(a,null,c);return a},parseJsonSchema:function(a,d,c){var b=this;if(c instanceof Array){b.parseJsonArraySchema(a,null,c)}else{b.parseJsonObjectSchema(a,null,c)}},parseJsonArraySchema:function(b,e,d){var c=this;var a=e==null?10:e*100+10;c.parseJsonSchema(b,a,d[0])},parseJsonObjectSchema:function(h,d,i){var b=this;var c="";var g=null;var e=null;var a=d==null?10:d*100+10;var e=new Object();for(var f in i){g=i[f];e=new Object();e.code=f;e.type=interUtilObj.parseParamValType(g);e.nodeId=a;e.parentId=d;h.push(e);c=Object.prototype.toString.call(g);if(c=="[object Array]"){b.parseJsonObjectSchema(h,a,g[0])}else{if(c=="[object Object]"){b.parseJsonObjectSchema(h,a,g)}}a++}}};var interUtilObj={parseParamValType:function(b){if(isNull(b)){return"sys_string"}var a=Object.prototype.toString.call(b);if(a=="[object Array]"){return"sys_array"}else{if(a=="[object Object]"){return"sys_object"}else{if(b.toString().toLowerCase()=="true"||b.toString().toLowerCase()=="false"){return"sys_boolean"}else{if(/(^-?\d+$)/.test(b)){return"sys_integer_int32"}else{if(/(^(-?\d+)(\.\d+)?$)/.test(b)){return"sys_number_double"}else{return"sys_string"}}}}}}};$(function(){interObj.init()});