/*!
 * Nestable jQuery Plugin - Copyright (c) 2012 David Bushell - http://dbushell.com/
 * Dual-licensed under the BSD or MIT licenses
 */
(function(f,c,a,g){var e="ontouchstart" in a;var d=(function(){var i=a.createElement("div");var j=a.documentElement;if(!("pointerEvents" in i.style)){return false}i.style.pointerEvents="auto";i.style.pointerEvents="x";j.appendChild(i);var h=c.getComputedStyle&&c.getComputedStyle(i,"").pointerEvents==="auto";j.removeChild(i);return !!h})();function b(i,h){this.w=f(a);this.el=f(i);this.options=f.extend({},f.fn.nestable.defaults,h);this.init()}b.prototype={init:function(){var k=this;k.reset();k.el.data("nestable-group",k.options.group);k.placeEl=f('<div class="'+k.options.placeClass+'"/>');f.each(this.el.find(k.options.itemNodeName+"."+k.options.itemClass),function(l,m){k.setParent(f(m))});k.el.on("click","button",function(o){if(k.dragEl){return}var n=f(o.currentTarget);var m=n.data("action");var l=n.parent(k.options.itemNodeName);if(m==="collapse"){k.collapseItem(l)}else{if(m==="expand"){k.expandItem(l)}else{if(m==="addChild"){if(k.options.getItemTmpl!=null&&typeof k.options.getItemTmpl==="function"){k.addChild(l,k.options.getItemTmpl())}}else{if(m==="removeItem"){k.removeItem(l)}}}}});var h=function(m){var l=f(m.target);if(!l.hasClass(k.options.handleClass)){if(l.closest("."+k.options.noDragClass).length){return}l=l.closest("."+k.options.handleClass)}if(!l.length||k.dragEl){return}k.isTouch=/^touch/.test(m.type);if(k.isTouch&&m.touches.length!==1){return}m.preventDefault();k.dragStart(m.touches?m.touches[0]:m)};var j=function(l){if(k.dragEl){l.preventDefault();k.dragMove(l.touches?l.touches[0]:l)}};var i=function(l){if(k.dragEl){l.preventDefault();k.dragStop(l.touches?l.touches[0]:l)}};if(e){k.el[0].addEventListener("touchstart",h,false);c.addEventListener("touchmove",j,false);c.addEventListener("touchend",i,false);c.addEventListener("touchcancel",i,false)}k.el.on("mousedown",h);k.w.on("mousemove",j);k.w.on("mouseup",i)},serialize:function(){var j;var k=0;var i=this;var h=function(o,m){var n=[];var l=o.children(i.options.itemNodeName);l.each(function(){var p=f(this);var r=f.extend({},i.options.getItemContent(p));var q=p.children(i.options.listNodeName);if(q.length){r.children=h(q,m+1)}n.push(r)});return n};j=h(i.el.find(i.options.listNodeName).first(),k);return j},reset:function(){this.mouse={offsetX:0,offsetY:0,startX:0,startY:0,lastX:0,lastY:0,nowX:0,nowY:0,distX:0,distY:0,dirAx:0,dirX:0,dirY:0,lastDirX:0,lastDirY:0,distAxX:0,distAxY:0};this.isTouch=false;this.moving=false;this.dragEl=null;this.dragRootEl=null;this.dragDepth=0;this.hasNewRoot=false;this.pointEl=null},hideAction:function(h,i){h.children('[data-action="'+i+'"]').hide()},addChild:function(h,i){var k=this.options;if(!i){i=k.getItemTmpl()}if(h){var l=h.find(k.listNodeName).first();var m=h.parents(k.listNodeName).length;if(m+1<=k.maxDepth){if(!l.length){l=f("<"+k.listNodeName+"/>").addClass(k.listClass);h.append(l)}l.append(i);this.setParent(i);this.setParent(h);this.el.trigger("change")}}else{var j=this.el.children(k.listNodeName);if(j.length==0){j=f(k.itemListStructHTML);this.el.append(j)}j.append(i);this.setParent(i);this.el.trigger("change")}if(k.afterAddChild!=null&&typeof k.afterAddChild==="function"){k.afterAddChild(i)}},removeItem:function(h){var i=h;var j=this.options;var k=h.parents(j.listNodeName).first();h.remove();if(k.children().length==0){var l=k.parent(j.itemNodeName).first();if(l){this.unsetParent(l)}k.remove()}this.el.trigger("change");if(j.afterRemoveItem!=null&&typeof j.afterRemoveItem==="function"){j.afterRemoveItem(i)}},expandItem:function(h){h.removeClass(this.options.collapsedClass);h.children('[data-action="expand"]').hide();h.children('[data-action="collapse"]').show();h.children(this.options.listNodeName).show()},collapseItem:function(i){var h=i.children(this.options.listNodeName);if(h.length){i.addClass(this.options.collapsedClass);i.children('[data-action="collapse"]').hide();i.children('[data-action="expand"]').show();i.children(this.options.listNodeName).hide()}},expandAll:function(){var h=this;h.el.find(h.options.itemNodeName).each(function(){h.expandItem(f(this))})},collapseAll:function(){var h=this;h.el.find(h.options.itemNodeName).each(function(){h.collapseItem(f(this))})},setParent:function(h){h.children("[data-action]").remove();var i=this.options;if(i.enableAddChild){h.prepend(f(i.addChildBtnHTML))}if(i.enableRemoveItem){h.prepend(f(i.removeBtnHTML))}if(h.children(i.listNodeName).length>0){h.prepend(f(i.expandBtnHTML));h.prepend(f(i.collapseBtnHTML))}h.children('[data-action="expand"]').hide()},unsetParent:function(h){var i=this.options;h.removeClass(i.collapsedClass);h.children("[data-action]").remove();if(i.enableAddChild){h.prepend(f(i.addChildBtnHTML))}if(i.enableRemoveItem){h.prepend(f(i.removeBtnHTML))}h.children(i.listNodeName).remove()},loadData:function(h){this.options.loadData(this.el,h)},getData:function(){return this.options.getData(this)},clear:function(){f(this.el).children(this.options.listNodeName).first().remove()},getOptions:function(h){if(h){return this.options[h]}else{return this.options}},setOptions:function(h,i){this.options[h]=i},dragStart:function(n){var j=this.mouse;var m=f(n.target);var l=m.closest(this.options.itemNodeName);this.placeEl.css("height",l.height());j.offsetX=n.offsetX!==g?n.offsetX:n.pageX-m.offset().left;j.offsetY=n.offsetY!==g?n.offsetY:n.pageY-m.offset().top;j.startX=j.lastX=n.pageX;j.startY=j.lastY=n.pageY;this.dragRootEl=this.el;this.dragEl=f(a.createElement(this.options.listNodeName)).addClass(this.options.listClass+" "+this.options.dragClass);this.dragEl.css("width",l.width());l.after(this.placeEl);l[0].parentNode.removeChild(l[0]);l.appendTo(this.dragEl);f(a.body).append(this.dragEl);this.dragEl.css({left:n.pageX-j.offsetX,top:n.pageY-j.offsetY});var k;var o;var h=this.dragEl.find(this.options.itemNodeName);for(k=0;k<h.length;k++){o=f(h[k]).parents(this.options.listNodeName).length;if(o>this.dragDepth){this.dragDepth=o}}},dragStop:function(i){var h=this.dragEl.children(this.options.itemNodeName).first();h[0].parentNode.removeChild(h[0]);this.placeEl.replaceWith(h);this.dragEl.remove();this.el.trigger("change");if(this.hasNewRoot){this.dragRootEl.trigger("change")}this.reset()},dragMove:function(o){var p;var t;var j;var m;var l;var i=this.options;var q=this.mouse;this.dragEl.css({left:o.pageX-q.offsetX,top:o.pageY-q.offsetY});q.lastX=q.nowX;q.lastY=q.nowY;q.nowX=o.pageX;q.nowY=o.pageY;q.distX=q.nowX-q.lastX;q.distY=q.nowY-q.lastY;q.lastDirX=q.dirX;q.lastDirY=q.dirY;q.dirX=q.distX===0?0:q.distX>0?1:-1;q.dirY=q.distY===0?0:q.distY>0?1:-1;var h=Math.abs(q.distX)>Math.abs(q.distY)?1:0;if(!q.moving){q.dirAx=h;q.moving=true;return}if(q.dirAx!==h){q.distAxX=0;q.distAxY=0}else{q.distAxX+=Math.abs(q.distX);if(q.dirX!==0&&q.dirX!==q.lastDirX){q.distAxX=0}q.distAxY+=Math.abs(q.distY);if(q.dirY!==0&&q.dirY!==q.lastDirY){q.distAxY=0}}q.dirAx=h;if(i.enableHorizontalMove&&q.dirAx&&q.distAxX>=i.threshold){q.distAxX=0;j=this.placeEl.prev(i.itemNodeName);if(q.distX>0&&j.length&&!j.hasClass(i.collapsedClass)){p=j.find(i.listNodeName).last();l=this.placeEl.parents(i.listNodeName).length;if(l+this.dragDepth<=i.maxDepth){if(!p.length){p=f("<"+i.listNodeName+"/>").addClass(i.listClass);p.append(this.placeEl);j.append(p);this.setParent(j)}else{p=j.children(i.listNodeName).last();p.append(this.placeEl)}}}if(q.distX<0){m=this.placeEl.next(i.itemNodeName);if(!m.length){t=this.placeEl.parent();this.placeEl.closest(i.itemNodeName).after(this.placeEl);if(!t.children().length){this.unsetParent(t.parent())}}}}var k=false;if(!d){this.dragEl[0].style.visibility="hidden"}this.pointEl=f(a.elementFromPoint(o.pageX-a.body.scrollLeft,o.pageY-(c.pageYOffset||a.documentElement.scrollTop)));if(!d){this.dragEl[0].style.visibility="visible"}if(this.pointEl.hasClass(i.handleClass)){this.pointEl=this.pointEl.parent(i.itemNodeName)}if(this.pointEl.hasClass(i.emptyClass)){k=true}else{if(!this.pointEl.length||!this.pointEl.hasClass(i.itemClass)){return}}var n=this.pointEl.closest("."+i.rootClass),s=this.dragRootEl.data("nestable-id")!==n.data("nestable-id");if(i.enableVerticalMove&&(!q.dirAx||s||k)){if(s&&i.group!==n.data("nestable-group")){return}l=this.dragDepth-1+this.pointEl.parents(i.listNodeName).length;if(l>i.maxDepth){return}var r=o.pageY<(this.pointEl.offset().top+this.pointEl.height()/2);t=this.placeEl.parent();if(k){p=f(a.createElement(i.listNodeName)).addClass(i.listClass);p.append(this.placeEl);this.pointEl.replaceWith(p)}else{if(r){this.pointEl.before(this.placeEl)}else{this.pointEl.after(this.placeEl)}}if(!t.children().length){this.unsetParent(t.parent())}if(!this.dragRootEl.find(i.itemNodeName).length){this.dragRootEl.append('<div class="'+i.emptyClass+'"/>')}if(s){this.dragRootEl=n;this.hasNewRoot=this.el[0]!==this.dragRootEl[0]}}}};f.fn.nestable=function(k){var h=this;var j=this;var i=arguments;h.each(function(){var l=f(this).data("nestable");if(!l){f(this).data("nestable",new b(this,k));f(this).data("nestable-id",new Date().getTime())}else{if(typeof k==="string"&&typeof l[k]==="function"){j=l[k].apply(l,Array.prototype.slice.call(i,1))}}});return j||h};f.fn.nestable.defaults={listNodeName:"ol",itemNodeName:"li",rootClass:"dd",listClass:"dd-list",itemClass:"dd-item",dragClass:"dd-dragel",handleClass:"dd-handle",collapsedClass:"dd-collapsed",placeClass:"dd-placeholder",noDragClass:"dd-nodrag",emptyClass:"dd-empty",expandBtnHTML:'<button data-action="expand" type="button">Expand</button>',collapseBtnHTML:'<button data-action="collapse" type="button">Collapse</button>',addChildBtnHTML:'<button data-action="addChild" type="button">AddChild</button>',removeBtnHTML:'<button data-action="removeItem" type="button">RemoveItem</button>',group:0,maxDepth:5,threshold:20,enableAddChild:true,enableRemoveItem:true,enableVerticalMove:true,enableHorizontalMove:true,itemStructHTML:'<li class="dd-item dd-item-drag"><div class="dd-handle dd-handle-drag"></div><div class="dd-content"></div></li',itemListStructHTML:'<ol class="dd-list"></ol>',afterAddChild:function(h){},afterRemoveItem:function(h){},getItemTmpl:function(){var h=this.getItemContentTmpl();var i=f(this.itemStructHTML);if(h){i.find(".dd-content").append(h)}return i},getItemContentTmpl:function(){return f('<input class="form-control"/>')},getItemContent:function(h){return h.children(".dd-content").find("*").getFieldsValue()},getData:function(j){var h=[];var i=function(m,k){var l=m*100+10;f.each(k,function(n,p){p.nodeId=""+l;p.parentId=m==0?null:""+m;var o=p.children;if(o){delete p.children;h.push(p);i(l,o)}else{h.push(p)}l++})};i(0,j.serialize());return h},loadData:function(j,l){if(!l||l.length==0){return}var i=this;var h=f(i.itemListStructHTML);f.each(l,function(o,n){var q=f(i.itemStructHTML);q.attr("data-id",n.nodeId);q.find(".dd-content").append(i.getItemContentTmpl());q.find("*").setFieldsValue(n);q.data("itemData",n);if(!n.parentId||n.parentId==null){h.append(q)}else{var m=h.find("[data-id="+n.parentId+"]").first();var p=m.find(i.listNodeName).first();if(!p||p.length==0){p=f(i.itemListStructHTML);m.append(p)}p.append(q)}});var k=f(j);k.nestable("clear");k.append(h);f.each(j.find(i.itemNodeName+"."+i.itemClass),function(m,n){k.nestable("setParent",f(n));i.afterAddChild(f(n))})}}})(window.jQuery||window.Zepto,window,document);