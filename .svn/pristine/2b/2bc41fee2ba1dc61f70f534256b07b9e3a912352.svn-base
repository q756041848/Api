var staticInfo={cataNodeIdCode:-10,cataNodeIdSchema:-20,cataNodeIdInter:-30,moduleNodeIdDef:-1,moduleNodeIdRecycle:-2,moduleNodeIdNoGroup:-3};var privObj={privPerm:$("#operPerm").val(),hasPerm:function(a){return this.privPerm.indexOf(a)!=-1},enableModuleAdd:function(){return this.hasPerm("docModule:add")},enableModuleUpdate:function(){return this.hasPerm("docModule:update")},enableCodeAdd:function(){return this.hasPerm("docCode:add")},enableCodeUpdate:function(){return this.hasPerm("docCode:update")},enableInterTreeLoad:function(){return this.hasPerm("interTree:load")},enableInterTreeSort:function(){return this.hasPerm("interTree:sort")},enableInterTreeDel:function(){return this.hasPerm("interTree:del")},enableInterDetailInfo:function(){return this.hasPerm("inter:detailInfo")},enableInterDetailAdd:function(){return this.hasPerm("inter:addDetail")},enableInterDetailUpdate:function(){return this.hasPerm("inter:updateDetail")}};var interTreeObj={init:function(){if(!privObj.enableInterTreeLoad()){return}var b=this;var a={async:{enable:true,url:"auth/doc/inter/tree/json/load.htm",autoParam:["id=parentNodeId","dataId=parentDataId","type=nodeType"],otherParam:{docId:$("#docId").val(),condition:$("#condition").val()},dataFilter:ajaxDataFilter,headers:{sysReqToken:$("#sysReqToken").val()}},view:{expandSpeed:"",fontCss:getFont,addHoverDom:b.addHoverDom,removeHoverDom:b.removeHoverDom,selectedMulti:false,showLine:false,showIcon:true,dblClickExpand:false},edit:{enable:true,drag:{autoExpandTrigger:true},showRemoveBtn:false,showRenameBtn:false},data:{keep:{parent:true},simpleData:{enable:true},key:{title:"title"}},callback:{beforeDrop:b.beforeDropCallbackCust,onDrop:b.dropCallback,onClick:b.clickCallback}};$.fn.zTree.init($("#interTree"),a);$("#searchBtn").click(function(){b.searchTree()});$("#condition").bind("keypress",function(c){if(c.keyCode=="13"){b.searchTree()}})},searchTree:function(){var a=$.fn.zTree.getZTreeObj("interTree");a.reAsyncChildNodes(null,"refresh",true,{async:{otherParam:{docId:$("#docId").val(),condition:$("#condition").val()},}})},beforeDropCallbackCust:function(d,c,e,b,a){if(!privObj.enableInterTreeSort()){return false}return beforeDropCallback(d,c,e,b,a)},dropCallback:function(b,e,d,f,i){if(f==null){return}var h=d[0];var a=new Object();a.dataId=h.dataId;a.parentDataId=h.parentDataId;a.type=h.type;a.parentType=h.parentType;a.isParent=h.isParent;var g=new Object();g.dataId=f.dataId;g.parentDataId=f.parentDataId;g.type=f.type;g.parentType=f.parentType;g.isParent=f.isParent;var c=new Object();c.srcNodeInfo=JSON.stringify(a);c.targetNodeInfo=JSON.stringify(g);c.docId=$("#docId").val();c.moveType=i;doPost("auth/doc/inter/tree/json/sort.htm",c,function(){if(a.type!="inter"){return}var m=null;var j=null;if(g.type!="inter"){if(a.parentDataId!=g.dataId){m=a.parentDataId;j=g.dataId}}else{if(a.parentDataId!=g.parentDataId){m=a.parentDataId;j=g.parentDataId}}if(m!=null&&j!=null){var n=interTreeObj.getNodeByDataId(m,"module");var l=interTreeObj.getNodeByDataId(j,"module");var k=$.fn.zTree.getZTreeObj("interTree");k.reAsyncChildNodes(n,"refresh",true,null,function(o){interTreeObj.updateNodeName(n,n.title,o.length)});k.reAsyncChildNodes(l,"refresh",false,null,function(p){interTreeObj.updateNodeName(l,l.title,p.length);var o=interTreeObj.getNodeByDataId(a.dataId,"inter");k.selectNode(o)})}})},clickCallback:function(a,c,b){if(b.dataId<=0){return}interObj.isChanged(function(){if(b.type=="module"){moduleObj.loadInfo(b.dataId,b.tId)}else{if(b.type=="inter"){interObj.loadInfo(b.dataId,false,b.tId)}else{if(b.type=="code"){errorCodeObj.loadInfo($("#docId").val(),b.dataId,b.tId)}}}})},addHoverDom:function(e,d){var b="node_oper_"+d.tId;if($("#"+b).length>0){return}var f=$("<span class='node_oper' id='"+b+"'></span>");if(d.type=="cata"){if(d.dataId==staticInfo.cataNodeIdCode&&privObj.enableCodeAdd()){f.append("<span class='add' title='新增返回码' onfocus='this.blur();'><i class='fa fa-plus'></i></span>")}else{if(d.dataId==staticInfo.cataNodeIdInter&&privObj.enableModuleAdd()){f.append("<span class='add' title='新增模块' onfocus='this.blur();'><i class='fa fa-plus'></i></span>")}}f.append("<span class='refresh' title='重新加载' onfocus='this.blur();'><i class='fa fa-refresh'></i></span>")}else{if(d.type=="module"){var a=interTreeObj.getModuleCateId(d.id);if(a==staticInfo.cataNodeIdInter){if(privObj.enableInterDetailInfo()){f.append("<span class='add' title='新增接口' onfocus='this.blur();'><i class='fa fa-plus'></i></span>")}if(d.enableEdit!=false&&privObj.enableModuleUpdate()){f.append("<span class='edit' title='编辑模块' onfocus='this.blur();'><i class='fa fa-edit'></i></span>")}if(d.enableDel!=false&&privObj.enableInterTreeDel()){f.append("<span class='remove' title='删除模块' onfocus='this.blur();'><i class='fa fa-trash-o'></i></span>")}f.append("<span class='refresh' title='加载接口' onfocus='this.blur();'><i class='fa fa-refresh'></i></span>");if($("#enableInterList").val()=="true"){f.append("<span class='list' title='列表展示' onfocus='this.blur();'><i class='fa fa-list'></i></span>")}}else{if(a==staticInfo.cataNodeIdCode){if(privObj.enableCodeAdd()){f.append("<span class='add' title='新增返回码' onfocus='this.blur();'><i class='fa fa-plus'></i></span>")}if(d.enableEdit!=false&&privObj.enableModuleUpdate()){f.append("<span class='edit' title='编辑模块' onfocus='this.blur();'><i class='fa fa-edit'></i></span>")}if(d.enableDel!=false&&privObj.enableInterTreeDel()){f.append("<span class='remove' title='删除模块' onfocus='this.blur();'><i class='fa fa-trash-o'></i></span>")}f.append("<span class='refresh' title='加载返回码' onfocus='this.blur();'><i class='fa fa-refresh'></i></span>")}}}else{if(d.type=="inter"){if(privObj.enableInterDetailAdd()){f.append("<span class='copy' title='复制接口' onfocus='this.blur();'><i class='fa fa-copy'></i></span>")}if(privObj.enableInterDetailUpdate()){f.append("<span class='edit' title='编辑接口' onfocus='this.blur();'><i class='fa fa-edit'></i></span>")}if(privObj.enableInterTreeDel()){f.append("<span class='remove' title='删除接口' onfocus='this.blur();'><i class='fa fa-trash-o'></i></span>")}}else{if(d.type=="code"){if(privObj.enableCodeUpdate()){f.append("<span class='edit' title='编辑错误码' onfocus='this.blur();'><i class='fa fa-edit'></i></span>")}if(privObj.enableInterTreeDel()){f.append("<span class='remove' title='删除错误码' onfocus='this.blur();'><i class='fa fa-trash-o'></i></span>")}}}}}var c=$("#"+d.tId+"_span");c.after(f);f.find(".add").click(function(){interObj.isChanged(function(){if(d.type=="module"){var g=interTreeObj.getModuleCateId(d.id);if(g==staticInfo.cataNodeIdInter){interObj.initAddOper(d.dataId)}else{if(g==staticInfo.cataNodeIdCode){errorCodeObj.initAddOper(d.dataId)}}}else{if(d.type=="cata"){if(d.dataId==staticInfo.cataNodeIdCode){errorCodeObj.initAddOper()}else{if(d.dataId==staticInfo.cataNodeIdInter){moduleObj.initAddOper()}}}}});return false});f.find(".copy").click(function(g){interObj.isChanged(function(){if(d.type=="inter"){interObj.loadInfo(d.dataId,true)}});return false});f.find(".refresh").click(function(g){interObj.isChanged(function(){var h=$.fn.zTree.getZTreeObj("interTree");h.reAsyncChildNodes(d,"refresh",false,null,function(i){if(d.type=="module"){interTreeObj.updateNodeName(d,d.title,i.length)}})});return false});f.find(".list").click(function(g){interObj.isChanged(function(){if(d.type=="module"){interListObj.loadInfo(d.dataId)}});return false});f.find(".edit").click(function(){interObj.isChanged(function(){f.parent().click()});return false});f.find(".remove").click(function(){interObj.isChanged(function(){var h="确认执行删除操作？";if(d.type=="module"){h="确认删除该模块？<br/>删除后该模块下接口移到默认分组。"}var g=$.fn.zTree.getZTreeObj("interTree");g.selectNode(d);bootbox.confirm(h,function(){var i=new Object();i.dataId=d.dataId;i.type=d.type;i.docId=$("#docId").val();doPost("auth/doc/inter/tree/json/del.htm",i,function(k){g.removeNode(d);$("#apiSettingBtn").click();if(d.type=="module"){interBasicObj.loadModuleSelect()}else{if(d.type=="inter"){var j=d.getParentNode();interTreeObj.updateNodeName(j,j.title,j.childrenCount-1)}}})})});return false})},getModuleCateId:function(a){return parseInt(a.split("_")[1])},removeHoverDom:function(b,a){var c=$("#node_oper_"+a.tId);if(c.length>0){c.remove()}},updateNodeNameByNodeId:function(c,e){var d=this;var a=$.fn.zTree.getZTreeObj("interTree");var b=a.getNodeByTId(c);d.updateNodeName(b,e,b.childrenCount)},updateNodeName:function(c,d,b){var a=$.fn.zTree.getZTreeObj("interTree");c.name=filterNodeName(d);c.title=d;if(c.type=="module"&&b!=undefined){c.name=c.name+" ["+b+"]";c.childrenCount=b}a.updateNode(c)},addNode:function(c){var e=this;var a=e.getNodeByDataId(c.parentDataId,c.parentType);var b=$.fn.zTree.getZTreeObj("interTree");if(c.type=="module"){var d=b.addNodes(a,-1,c,true)[0];e.updateNodeName(d,d.name,0);b.selectNode(d)}else{if(c.type=="inter"){b.reAsyncChildNodes(a,"refresh",false,null,function(g){e.updateNodeName(a,a.title,g.length);var f=e.getNodeByDataId(c.dataId,c.type);b.selectNode(f)})}}if(c.type=="code"){b.reAsyncChildNodes(a,"refresh",false,null,function(g){var f=e.getNodeByDataId(c.dataId,c.type);b.selectNode(f)})}},getNodeByDataId:function(a,c){if(c==undefined){return null}var d=this;var b=$.fn.zTree.getZTreeObj("interTree");return b.getNodesByFilter(d.getNodeByDataIdFilter,true,null,{dataId:a,type:c})},getNodeByDataIdFilter:function(b,a){return(b.dataId==a.dataId)&&(b.type=a.type)}};var moduleObj={init:function(){var a=this;$("#moduleForm").bootstrapValidator({fields:{name:{validators:{notEmpty:{message:"名称不能为空"}}}}});$("#saveModuleBtn").click(function(){if(isFormValid("moduleForm")){var b=$("#moduleOperTypeId").val();if(b=="add"){a.addOper()}else{if(b=="update"){a.updateOper()}}}})},loadInfo:function(a,b){$(".nodeInfo").hide();$("#modulePanel").show();$("#moduleForm").data("treeNodeId",b);resetValidForm("moduleForm");$("#moduleOperTypeId").val("update");$("#moduleId").val(a);doGet("auth/doc/module/json/info.htm","moduleId="+a,function(c){$("#moduleForm").find("*").setFieldsValue(c)})},initAddOper:function(){resetValidForm("moduleForm");$("#moduleId").val("");$("#moduleOperTypeId").val("add");$(".nodeInfo").hide();$("#modulePanel").show()},addOper:function(){var a=$("#moduleForm").find("*").getFieldsValue();doPost("auth/doc/module/json/add.htm",a,function(b){notice("保存成功",function(){interTreeObj.addNode(b);interBasicObj.loadModuleSelect()})})},updateOper:function(){var a=$("#moduleForm").find("*").getFieldsValue();doPost("auth/doc/module/json/update.htm",a,function(b){notice("保存成功",function(){var c=$("#moduleForm").data("treeNodeId");if(c){interTreeObj.updateNodeNameByNodeId(c,a.name)}interBasicObj.loadModuleSelect()})})}};var errorCodeObj={init:function(){var a=this;$("#errorCodeForm").bootstrapValidator({fields:{code:{validators:{notEmpty:{message:"错误码不能为空"}}}}});$("#saveErrorCodeBtn").click(function(){if(isFormValid("errorCodeForm")){var b=$("#errorCodeOperTypeId").val();if(b=="add"){a.addOper()}else{if(b=="update"){a.updateOper()}}}})},loadInfo:function(a,d,b){$(".nodeInfo").hide();$("#errorCodePanel").show();$("#errorCodeForm").data("treeNodeId",b);resetValidForm("errorCodeForm");$("#errorCodeOperTypeId").val("update");$("#codeId").val(d);var c=new Object();c.docId=a;c.codeId=d;doGet("auth/doc/code/json/info.htm",c,function(e){$("#errorCodeForm").find("*").setFieldsValue(e)})},loadModuleSelect:function(){$("#errorCodeModuleId").empty();initSelectRemote("auth/doc/module/json/list.htm","docId="+$("#docId").val(),"#errorCodeModuleId")},initAddOper:function(a){resetValidForm("errorCodeForm");$("#codeId").val("");if(a!=undefined){$("#errorCodeModuleId").val(a)}$("#errorCodeOperTypeId").val("add");$(".nodeInfo").hide();$("#errorCodePanel").show()},addOper:function(){var a=$("#errorCodeForm").find("*").getFieldsValue();doPost("auth/doc/code/json/add.htm",a,function(b){notice("保存成功",function(){interTreeObj.addNode(b)})})},updateOper:function(){var a=$("#errorCodeForm").find("*").getFieldsValue();doPost("auth/doc/code/json/update.htm",a,function(b){notice("保存成功",function(){var c=$("#errorCodeForm").data("treeNodeId");if(c){interTreeObj.updateNodeNameByNodeId(c,a.code)}})})}};var interListObj={init:function(){var a=this;a.loadModuleSelect();$("#interListTable").bootstrapTable({classes:"table table-hover table-fixed",cache:false,pagination:true,queryParamsType:"",sidePagination:"server",pageNumber:1,pageSize:10,pageList:[10,25,50,100],dataField:"list",totalField:"totalCount",url:"auth/doc/inter/json/load.htm",ajaxOptions:{headers:{sysReqToken:$("#sysReqToken").val()}},queryParams:function(c){var b=$("#interListForm").find("*").getFieldsValue();b.pageSize=c.pageSize;b.pageNumber=c.pageNumber;return b},responseHandler:function(b){var d=b[this.dataField];if(d.length){for(var c=0;c<d.length;c++){d[c].index=c+1}}return b},columns:[{field:"index",title:"#","class":"table-index"},{field:"name",title:"名称","class":"col-lg-2"},{field:"path",title:"请求url","class":"col-lg-3"},{field:"moduleName",title:"所属模块","class":"col-lg-2"},{field:"modifyDate",title:"更新时间","class":"col-lg-2"},{field:"operation",title:"操作","class":"col-lg-3",formatter:function(d,e,c){var b='<span class="inter-list-oper"><a class="btn btn-sm btn-success copy" href="javascript:void(0);"><i class="fa fa-plus"></i> 复制</button><a class="btn btn-sm btn-primary edit" href="javascript:void(0);"><i class="fa fa-pencil"></i> 编辑</a><a class="btn btn-sm btn-danger delete" href="javascript:void(0);"><i class="fa fa-trash"></i> 删除</a>';+"</span>";return b},events:a.operateEvents},]});$("#interListSearchBtn").click(function(){$("#interListTable").bootstrapTable("refresh")})},operateEvents:{"click .inter-list-oper .copy":function(c,b,d,a){interObj.loadInfo(d.interId,true)},"click .inter-list-oper .edit":function(c,b,d,a){interObj.loadInfo(d.interId,false,null)},"click .inter-list-oper .delete":function(c,b,d,a){bootbox.confirm("确认执行删除操作",function(){var e=new Object();e.dataId=d.interId;e.type="inter";e.docId=$("#docId").val();doPost("auth/doc/inter/tree/json/del.htm",e,function(f){$("#interListTable").bootstrapTable("refresh")})})}},loadModuleSelect:function(){$("#interListModuleId").empty();initSelectRemote("auth/doc/module/json/list.htm","docId="+$("#docId").val(),"#interListModuleId")},loadInfo:function(a){$(".nodeInfo").hide();$("#interListPanel").show();$("#interListModuleId").val(a);$("#interListTable").bootstrapTable("refresh")}};$(function(){interTreeObj.init();apiDocObj.init();moduleObj.init();errorCodeObj.init();if($("#enableInterList").val()=="true"){interListObj.init()}initBtnClick()});function initBtnClick(){$("#apiSettingBtn").click(function(){interObj.isChanged(function(){$("#apiDocInfoTab").click()})});$("#addErrorCodeBtn").click(function(){interObj.isChanged(function(){errorCodeObj.initAddOper()})});$("#addModuleBtn").click(function(){interObj.isChanged(function(){moduleObj.initAddOper()})});$("#addInterBtn").click(function(){interObj.isChanged(function(){interObj.initAddOper()})})};